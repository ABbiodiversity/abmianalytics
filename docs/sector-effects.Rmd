---
title: Sector effects calculation and visualization for native and non-native species'
author: "Peter and Ermias"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: word_document
---

```{r eval=FALSE,echo=FALSE}
## processing vplant data for sample based non-native sector effects

library(mefa4)

load("e:/peter/AB_data_v2017/data/analysis/site/veg-hf_siteCenter_v6-fixage0.Rdata")
tv <- read.csv("~/repos/abmianalytics/lookup/lookup-veg-hf-age-V6.csv")
vhf <- as.matrix(dd_1ha$veg_current)
vhf <- vhf[,colnames(vhf) != "CutBlocks"]
a <- vhf / rowSums(vhf)
a <- a[,rownames(tv)]
a <- groupSums(a, 2, tv$ETA_UseInAnalysis_Sector)
summary(a)

load("e:/peter/AB_data_v2017/data/misc/VPlant.RData")

str(dd)
Y <- as.matrix(dd[,6:ncol(dd)])
Y[Y>0] <- 1

X <- dd[,1:6]
compare_sets(rownames(X), rownames(a))
Sites <- intersect(rownames(X), rownames(a))

X <- X[Sites,]
Y <- Y[Sites,]
A <- a[Sites,]

sp <- read.csv("e:/peter/AB_data_v2017/data/misc/VPlant Species analysis name_April 2017.csv")
compare_sets(sp$Analysis_Name, colnames(Y))
Z <- sp[match(colnames(Y), sp$Analysis_Name),]
rownames(Z) <- Z$Analysis_Name
Z <- droplevels(Z[Z$RANK_NAME == "Species",])
Z$NN <- Z$Origin_Analysis != "Native"
Y <- Y[,rownames(Z)]

save(X, Y, A, Z, file="e:/peter/AB_data_v2017/data/reporting/vpalnts-2017-11-16.Rdata")
```


# Intro

The goal of this document is to explain/clarify the sector effects calculation 
based on predicted relative abundances in 1 km$^2$ pixels.
We are going to explain the prediction inputs (so that Dave can implement 
it for mammals), the calculations, and the
visualization. At the end we will attempt to evaluate a few options
for calculating sector effects for non-native species. We will use 
province-wide vascular plant species data as demonstration. We provide the R
functions for calculations and visualization in the Appendix.

# Prediction

We make sector ($j$) specific predictions of current ($c_{is}$) and 
reference ($r_{is}$) abundances in each 1 km$^2$ pixel $i$ in a given reporting 
region (full province, LUF, natural region/subregion, custom unit, $i=1,...,n$ 
where $n$ is the number of pixels within a particular region).

We store the output as 2 combined North/South matrices (both being $n \times 7$
in dimenstion). The columns correspond to `Native`, 
`Misc`, `Agriculture`, `RuralUrban`, `Energy Transportation`,
`Transportation`, `Forestry`,
(all native veg/soil classes make up the `Native` class, `CC` forest stands make
up the `Forestry`):

```{r echo=FALSE,results='markup'}
hf <- read.csv("~/repos/abmianalytics/lookup/lookup-hf-class.csv")
knitr::kable(hf[,c("HF_GROUP", "Sector")])
```

# Sector effect calculations

1. Identify subset of pixels that belong withing the region,
2. add up the columns in the subsetted matrices (current: $C_{s}=\sum{c_{is}}$, and reference: $R_{s}=\sum{r_{is}}$),
3. calculate proportion of landbase in each sector: $A_{s}=\sum{A_{is}}$
4. calculate regional total sector effects: $SE^{(total)}_{s}=100 \times (C_{s} - R_{s})/\sum{R_{s}}$, and the regional unit effects: $SE^{(unit)}_{s}=100 \times SE^{(total)}_{s} / (100 \times A_{s} / \sum{A_{s}})$
5. calculate local sector effects: $SE^{(local)}_{s}=100 \times C_{s} / R_{s}$.

The local sector effects resemble intactness, that is calculated from the same 
data as $min(\sum{C_{s}}, \sum{R_{s}}) / max(\sum{C_{s}}, \sum{R_{s}})$ including
all the columns in the 2 matrices.

# Sector effect visualization

For presentation purposes we omit the `Native` and `Misc` categories.

```{r echo=FALSE,message=FALSE}
library(mefa4)
load("e:/peter/AB_data_v2017/data/reporting/Summary of VPlant abundance by sector.RData")
load("e:/peter/AB_data_v2016/out/kgrid/veg-hf_1kmgrid_fix-fire.Rdata")
tv0 <- read.csv("~/repos/abmianalytics/lookup/lookup-veg-hf-age.csv")
tv0$Sector2 <- factor(ifelse(is.na(tv0$Sector), "NATIVE", as.character(tv0$Sector)),
    c("NATIVE", "Agriculture", "Energy", "Forestry", "Misc", "RuralUrban", "Transportation"))
VHF <- dd1km_pred[[1]]
tv0 <- tv0[colnames(VHF),]

CS <- colSums(groupSums(VHF/10^6, 2, tv0$Sector2))
CS <- CS / sum(CS)

#NN <- VP_SectorAbundance.Curr / rowSums(VP_SectorAbundance.Curr)
#DD <- t(t(NN) / CS)

#SE2 <- 100 * DD[,colnames(DD) != "Native"] / DD[,"Native"]
#SE2 <- SE2[rownames(SE),]

SEtot <- 100 * (VP_SectorAbundance.Curr - VP_SectorAbundance.Ref) / rowSums(VP_SectorAbundance.Ref)
A <- 100*CS
SEunit <- t(100 * t(SEtot) / A)


Curr <- VP_SectorAbundance.Curr["Achillea.millefolium",]
Ref <- VP_SectorAbundance.Ref["Achillea.millefolium",]
Area <- A

## Sector effect plot from Dave
plot_SE_regional <- function(Curr, Ref, Area, main="") {
    sectors <- c("Agriculture","Forestry","Energy","RuralUrban","Transportation")
    sector.names <- c("Agriculture","Forestry","Energy","RuralUrban","Transport")
    c1 <- c("tan3","palegreen4","indianred3","skyblue3","slateblue2")
    
    total.effect <- (100 * (Curr - Ref) / sum(Ref))[sectors]
    unit.effect <- 100 * total.effect / Area[sectors]
    ymax <- ifelse(max(abs(unit.effect))<20,20,
        ifelse(max(abs(unit.effect))<50,50,round(max(abs(unit.effect))+50,-2)))
    ymin <- ifelse(ymax>50,min(-100,round(min(unit.effect)-50,-2)),-ymax)
    ymax <- max(ymax,max(unit.effect)+0.08*(max(unit.effect)-min(unit.effect,0)))
    ymin <- min(ymin,min(unit.effect)-0.08*(max(unit.effect,0)-min(unit.effect)))
    q <- barplot(unit.effect,
        width=Area[sectors],
        space=0,col=c1,border=c1,ylim=c(ymin,ymax),
        ylab="Unit effect (%)",xlab="Area (% of region)",
        xaxt="n",cex.lab=1.3,cex.axis=1.2,tcl=0.3,
        xlim=c(0,round(sum(Area[sectors])+1,0)),
        bty="n",col.axis="grey40",col.lab="grey40",las=2)
    
    rect(par("usr")[1],par("usr")[3],par("usr")[2],par("usr")[4],col = "gray88",border="gray88")
    x.at<-pretty(c(0,sum(Area[sectors])))
    axis(side=1,tck=1,at=x.at,lab=rep("",length(x.at)),col="grey95")
    y.at<-pretty(c(ymin,ymax),n=6)
    axis(side=2,tck=1,at=y.at,lab=rep("",length(y.at)),col="grey95")
    q <- barplot(unit.effect,
        width=Area[sectors],
        space=0,col=c1,border=c1,ylim=c(ymin,ymax),
        ylab="Unit effect (%)",xlab="Area (% of region)",
        xaxt="n",cex.lab=1.3,cex.axis=1.2,tcl=0.3,
        xlim=c(0,round(sum(Area[sectors])+1,0)),
        bty="n",col.axis="grey40",col.lab="grey40",las=2,add=TRUE)
    box(bty="l",col="grey40")
    #mtext(side=1,line=2,at=x.at,x.at,col="grey40",cex=1.2)
    axis(side=1,at=x.at,tcl=0.3,lab=rep("",length(x.at)),col="grey40",
        col.axis="grey40",cex.axis=1.2,las=1)
    abline(h=0,lwd=2,col="grey40")
    mtext(side=1,at=q+c(0,0,-1,0,+1),sector.names,col=c1,cex=1.3,
        adj=0.5,line=c(0.1,0.1,1.1,0.1,1.1))
    y <- unit.effect+0.025*(ymax-ymin)*sign(unit.effect)
    if (abs(y[3]-y[4])<0.05*(ymax-ymin))
        y[3:4]<-mean(y[3:4])+(c(-0.015,0.015)*(ymax-ymin))[rank(y[3:4])]
    if (abs(y[4]-y[5])<0.05*(ymax-ymin))
        y[4:5]<-mean(y[4:5])+(c(-0.015,0.015)*(ymax-ymin))[rank(y[4:5])]
    text(q,y,paste(ifelse(total.effect>0,"+",""),
        sprintf("%.1f",total.effect),"%",sep=""),col="darkblue",cex=1.4)
    mtext(side=3,line=1,at=0,adj=0, main, cex=1.4,col="grey40")
    invisible(rbind(total=total.effect, unit=unit.effect, area=Area[sectors]))
}
plot_SE_local <- function(Curr, Ref, main="") {
    sectors <- c("Agriculture","Forestry","Energy","RuralUrban","Transportation")
    sector.names <- c("Agriculture","Forestry","Energy","RuralUrban","Transport")
    c1 <- c("tan3","palegreen4","indianred3","skyblue3","slateblue2")
    total.effect <- 100 * (Curr / Ref)[sectors]
    Area <- total.effect
    Area[] <- 1
    ymax <- if (max(total.effect)<100)
        200 else min(max(total.effect), 1000)
    ymax <- ymax * 1.08
    ymin <- 0
    ## This is to leave enough space at the top of bars for the text giving the % population change
    q <- barplot(total.effect,
        space=0.1,col=c1,border=c1,ylim=c(ymin,ymax),
        ylab="Local sector effect (%)",xlab="Sectors",
        xaxt="n",cex.lab=1.3,cex.axis=1.2,tcl=0.3,
        bty="n",col.axis="grey40",col.lab="grey40",las=2)
    
    rect(par("usr")[1],par("usr")[3],par("usr")[2],par("usr")[4],col = "gray88",border="gray88")
    y.at<-pretty(c(ymin,ymax),n=6)
    axis(side=2,tck=1,at=y.at,lab=rep("",length(y.at)),col="grey95")
    q <- barplot(total.effect,
        space=0.1,col=c1,border=c1,ylim=c(ymin,ymax),
        ylab="Local sector effect (%)",xlab="Sectors",
        xaxt="n",cex.lab=1.3,cex.axis=1.2,tcl=0.3,
        bty="n",col.axis="grey40",col.lab="grey40",las=2,add=TRUE)
    box(bty="l",col="grey40")
    abline(h=c(0, 100),lwd=2,col="grey40")
    mtext(side=1,at=q,sector.names,col=c1,cex=1.3,adj=0.5)

    y <- total.effect+0.025*(ymax-ymin)*sign(total.effect)
    if (abs(y[3]-y[4])<0.05*(ymax-ymin))
        y[3:4]<-mean(y[3:4])+(c(-0.015,0.015)*(ymax-ymin))[rank(y[3:4])]
    text(q,y,paste(sprintf("%.1f",total.effect),"%",sep=""),col="darkblue",cex=1.4)
    mtext(side=3,line=1,at=0,adj=0, main, cex=1.4,col="grey40")
    invisible(total.effect)
}

```

We are making sector effect plots for yarrow (*Achillea millefolium*).
`Curr` is a vector with current abundances by sector ($C_s$),
`Ref` is a vector with reference abundances by sector ($R_s$),
`Area` is a vector with corresponding percent areas:

```{r}
Curr
Ref
Area
```

We call a function to make a plot for regional sector effects:

```{r fig.width=6,fig.height=6}
plot_SE_regional(Curr, Ref, Area, main="Common Yarrow")
```

We call another function to make a plot for local sector effects (note,
no need to feed in percent `Area`):

```{r fig.width=6,fig.height=6}
plot_SE_local(Curr, Ref, main="Common Yarrow")
```

In production, we loop over the species and make PNG figures as:

```{r eval=FALSE}
png(paste0("regionalSE/", species_name, ".png")), width=600, height=600)
plot_SE_regional(Curr, Ref, Area, main=species_name)
dev.off()

png(paste0("localSE/", species_name, ".png")), width=600, height=600)
plot_SE_local(Curr, Ref, main=species_name)
dev.off()
```

# Options for non-native species

```{r echo=FALSE,message=FALSE,warning=FALSE}
## load
library(mefa4)
load("e:/peter/AB_data_v2017/data/reporting/vpalnts-2017-11-16.Rdata")

## subset here to the region in question

P <- t(sapply(colnames(Y), function(i) colMeans(A * Y[,i])))
SE <- 100 * P[,colnames(P) != "NATIVE"] / P[,"NATIVE"]
SI <- 100 * (1 - colMeans(Y))

P1 <- rowSums(P[,colnames(P) != "NATIVE"])
P0 <- P[,"NATIVE"]
SIv <- 100 * pmin(P1, P0) / pmax(P1, P0)

#plot(SI[Z$NN], SIv[Z$NN])

tmp <- rbind(data.frame(SI=SI[Z$NN], SE[Z$NN,], NN=1),
    data.frame(SI=SI[!Z$NN], SE[!Z$NN,], NN=0))
tmp <- tmp[,colnames(tmp) != "Misc"]
#write.csv(tmp, file="e:/peter/AB_data_v2017/data/reporting/nn-plant-sector-effects.csv")


NN <- VP_SectorAbundance.Curr / rowSums(VP_SectorAbundance.Curr)
DD <- t(t(NN) / CS)

SE2 <- 100 * DD[,colnames(DD) != "Native"] / DD[,"Native"]
SE2 <- SE2[rownames(SE),]
```

For non-native species we currently do not show anything that is based on reference
abundance, because that is 0 by definition.
This however, leads to division by 0 when we try to calculate sector effects.

An alternative way of sector effects for non-native species would be
to compare relative abudnance in a sector to that of found in native habitats.
We can du that either based on the data as a proportion weighted occurrence
(similar to the weighted selection index we use for uncommon species),
or based on the current prediction matrix as outlined above.

The data based effects underestimate the effects because most
disturbances at the 1 ha scale do not usually cover the entire plot (except for agriculture),
so detections are not tied to the footprint.

This is remedied by modeling, but the model based estimates.
The model based results indicate that most of the non-native plants
are more abundant in footprint, and effects are sometimes crazy high.
This is in fact in line with expectations (something larger than 0
is infinitely more abundant than 0).

So the question: do we want to proceed without presenting sector effects,
or we want to pursue this 'current condition based' metric for non-native species
(and thus creating another layer of complexity when explaining sector effects)?


```{r echo=FALSE,fig.width=9,fig.height=6}
op <- par(mfrow=c(2,3))
for (i in 2:6) {
plot(SE[Z$NN,i], SE2[Z$NN,i], xlab="Data based", ylab="Prediction based", 
     ylim=c(0, 4000), xlim=c(0, 500), main=colnames(SE)[i])
abline(0,1,col="grey")
abline(h=100,v=100,col="grey", lty=2)
}
par(op)
```

```{r echo=FALSE,fig.width=8,fig.height=8}
op <- par(mfrow=c(2,1))
boxplot(SE[Z$NN,], ylim=c(0,2000))
abline(h=100)
boxplot(SE2[Z$NN,], ylim=c(0,10000))
abline(h=100)
par(op)

```


# Appendix: R functions

```{r eval=FALSE}
plot_SE_regional <- function(Curr, Ref, Area, main="") {
    sectors <- c("Agriculture","Forestry","Energy","RuralUrban","Transportation")
    sector.names <- c("Agriculture","Forestry","Energy","RuralUrban","Transport")
    c1 <- c("tan3","palegreen4","indianred3","skyblue3","slateblue2")
    total.effect <- (100 * (Curr - Ref) / sum(Ref))[sectors]
    unit.effect <- 100 * total.effect / Area[sectors]
    ymax <- ifelse(max(abs(unit.effect))<20,20,
        ifelse(max(abs(unit.effect))<50,50,round(max(abs(unit.effect))+50,-2)))
    ymin <- ifelse(ymax>50,min(-100,round(min(unit.effect)-50,-2)),-ymax)
    ymax <- max(ymax,max(unit.effect)+0.08*(max(unit.effect)-min(unit.effect,0)))
    ymin <- min(ymin,min(unit.effect)-0.08*(max(unit.effect,0)-min(unit.effect)))
    q <- barplot(unit.effect,
        width=Area[sectors],
        space=0,col=c1,border=c1,ylim=c(ymin,ymax),
        ylab="Unit effect (%)",xlab="Area (% of region)",
        xaxt="n",cex.lab=1.3,cex.axis=1.2,tcl=0.3,
        xlim=c(0,round(sum(Area[sectors])+1,0)),
        bty="n",col.axis="grey40",col.lab="grey40",las=2)
    rect(par("usr")[1],par("usr")[3],par("usr")[2],par("usr")[4],
         col = "gray88",border="gray88")
    x.at<-pretty(c(0,sum(Area[sectors])))
    axis(side=1,tck=1,at=x.at,lab=rep("",length(x.at)),col="grey95")
    y.at<-pretty(c(ymin,ymax),n=6)
    axis(side=2,tck=1,at=y.at,lab=rep("",length(y.at)),col="grey95")
    q <- barplot(unit.effect,
        width=Area[sectors],
        space=0,col=c1,border=c1,ylim=c(ymin,ymax),
        ylab="Unit effect (%)",xlab="Area (% of region)",
        xaxt="n",cex.lab=1.3,cex.axis=1.2,tcl=0.3,
        xlim=c(0,round(sum(Area[sectors])+1,0)),
        bty="n",col.axis="grey40",col.lab="grey40",las=2,add=TRUE)
    box(bty="l",col="grey40")
    mtext(side=1,line=2,at=x.at,x.at,col="grey40",cex=1.2)
    axis(side=1,at=x.at,tcl=0.3,lab=rep("",length(x.at)),col="grey40",
        col.axis="grey40",cex.axis=1.2,las=1)
    abline(h=0,lwd=2,col="grey40")
    mtext(side=1,at=q+c(0,0,-1,0,+1),sector.names,col=c1,cex=1.3,
        adj=0.5,line=c(0.1,0.1,1.1,0.1,1.1))
    y <- unit.effect+0.025*(ymax-ymin)*sign(unit.effect)
    if (abs(y[3]-y[4])<0.05*(ymax-ymin))
        y[3:4]<-mean(y[3:4])+(c(-0.015,0.015)*(ymax-ymin))[rank(y[3:4])]
    if (abs(y[4]-y[5])<0.05*(ymax-ymin))
        y[4:5]<-mean(y[4:5])+(c(-0.015,0.015)*(ymax-ymin))[rank(y[4:5])]
    text(q,y,paste(ifelse(total.effect>0,"+",""),
        sprintf("%.1f",total.effect),"%",sep=""),col="darkblue",cex=1.4)
    mtext(side=3,line=1,at=0,adj=0, main, cex=1.4,col="grey40")
    invisible(rbind(total=total.effect, unit=unit.effect, area=Area[sectors]))
}

plot_SE_local <- function(Curr, Ref, main="") {
    sectors <- c("Agriculture","Forestry","Energy","RuralUrban","Transportation")
    sector.names <- c("Agriculture","Forestry","Energy","RuralUrban","Transport")
    c1 <- c("tan3","palegreen4","indianred3","skyblue3","slateblue2")
    total.effect <- 100 * (Curr / Ref)[sectors]
    Area <- total.effect
    Area[] <- 1
    ymax <- if (max(total.effect)<100)
        200 else max(min(max(total.effect), 1000), 200)
    ymax <- ymax * 1.08
    ymin <- 0
    q <- barplot(pmin(1000, total.effect),
        space=0.1,col=c1,border=c1,ylim=c(ymin,ymax),
        ylab="Local sector effect (%)",xlab="Sectors",
        xaxt="n",cex.lab=1.3,cex.axis=1.2,tcl=0.3,
        bty="n",col.axis="grey40",col.lab="grey40",las=2)
    rect(par("usr")[1],par("usr")[3],par("usr")[2],par("usr")[4],
         col = "gray88",border="gray88")
    y.at<-pretty(c(ymin,ymax),n=6)
    axis(side=2,tck=1,at=y.at,lab=rep("",length(y.at)),col="grey95")
    q <- barplot(pmin(1000, total.effect),
        space=0.1,col=c1,border=c1,ylim=c(ymin,ymax),
        ylab="Local sector effect (%)",xlab="Sectors",
        xaxt="n",cex.lab=1.3,cex.axis=1.2,tcl=0.3,
        bty="n",col.axis="grey40",col.lab="grey40",las=2,add=TRUE)
    box(bty="l",col="grey40")
    abline(h=c(0, 100),lwd=2,col="grey40")
    mtext(side=1,at=q,sector.names,col=c1,cex=1.3,adj=0.5)
    y <- pmin(1000, total.effect)+0.025*(ymax-ymin)*sign(pmin(1000, total.effect))
    if (abs(y[3]-y[4])<0.05*(ymax-ymin))
        y[3:4]<-mean(y[3:4])+(c(-0.015,0.015)*(ymax-ymin))[rank(y[3:4])]
    text(q,y,paste(sprintf("%.1f",total.effect),"%",sep=""),col="darkblue",cex=1.4)
    mtext(side=3,line=1,at=0,adj=0, main, cex=1.4,col="grey40")
    invisible(total.effect)
}
```

```{r eval=FALSE,echo=FALSE}
## producing some pdf's

Area <- 100*CS
pdf("sector-effect_local-regional.pdf", onefile=TRUE, width=20, height=8)
for (spp in rownames(Z)[!Z$NN]) {
    cat(spp, "\n")
    flush.console()
    Curr <- VP_SectorAbundance.Curr[spp,]
    Ref <- VP_SectorAbundance.Ref[spp,]
    op <- par(mfrow=c(1,2))
    plot_SE_regional(Curr, Ref, Area, main=paste("Regional SE:", spp))
    plot_SE_local(Curr, Ref, main=paste("Local SE:", spp))
    par(op)
}
dev.off()

```
