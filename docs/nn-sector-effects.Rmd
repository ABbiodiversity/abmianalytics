---
title: Sector effects calculation and visualization for native and non-native species'
author: "Peter and Ermias"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: pdf_document
---

```{r eval=FALSE,echo=FALSE}
## processing vplant data for sample based non-native sector effects

library(mefa4)

load("e:/peter/AB_data_v2017/data/analysis/site/veg-hf_siteCenter_v6-fixage0.Rdata")
tv <- read.csv("~/repos/abmianalytics/lookup/lookup-veg-hf-age-V6.csv")
vhf <- as.matrix(dd_1ha$veg_current)
vhf <- vhf[,colnames(vhf) != "CutBlocks"]
a <- vhf / rowSums(vhf)
a <- a[,rownames(tv)]
a <- groupSums(a, 2, tv$ETA_UseInAnalysis_Sector)
summary(a)

load("e:/peter/AB_data_v2017/data/misc/VPlant.RData")

str(dd)
Y <- as.matrix(dd[,6:ncol(dd)])
Y[Y>0] <- 1

X <- dd[,1:6]
compare_sets(rownames(X), rownames(a))
Sites <- intersect(rownames(X), rownames(a))

X <- X[Sites,]
Y <- Y[Sites,]
A <- a[Sites,]

sp <- read.csv("e:/peter/AB_data_v2017/data/misc/VPlant Species analysis name_April 2017.csv")
compare_sets(sp$Analysis_Name, colnames(Y))
Z <- sp[match(colnames(Y), sp$Analysis_Name),]
rownames(Z) <- Z$Analysis_Name
Z <- droplevels(Z[Z$RANK_NAME == "Species",])
Z$NN <- Z$Origin_Analysis != "Native"
Y <- Y[,rownames(Z)]

save(X, Y, A, Z, file="e:/peter/AB_data_v2017/data/reporting/vpalnts-2017-11-16.Rdata")
```


# Intro

The goal of this document is to explain/clarify the sector effects calculation 
based on predicted relative abundances in 1 km$^2$ pixels.
We are going to explain the prediction inputs (so that Dave can implement 
it for mammals), the calculations, and the
visualization. At the end we will attempt to evaluate a few options
for calculating sector effects for non-native species. We will use 
province-wide vascular plant species data as demonstration. We provide the R
functions for calculations and visualization in the Appendix.

# Prediction

# Sector effect calculations

# Sector effect visualization

# Options for non-native species

# Appendix: R functions


```{r echo=FALSE,message=FALSE,warning=FALSE}
## load
library(mefa4)
load("e:/peter/AB_data_v2017/data/reporting/vpalnts-2017-11-16.Rdata")

## subset here to the region in question

P <- t(sapply(colnames(Y), function(i) colMeans(A * Y[,i])))
SE <- 100 * P[,colnames(P) != "NATIVE"] / P[,"NATIVE"]
SI <- 100 * (1 - colMeans(Y))

P1 <- rowSums(P[,colnames(P) != "NATIVE"])
P0 <- P[,"NATIVE"]
SIv <- 100 * pmin(P1, P0) / pmax(P1, P0)

#plot(SI[Z$NN], SIv[Z$NN])

tmp <- rbind(data.frame(SI=SI[Z$NN], SE[Z$NN,], NN=1),
    data.frame(SI=SI[!Z$NN], SE[!Z$NN,], NN=0))
tmp <- tmp[,colnames(tmp) != "Misc"]
#write.csv(tmp, file="e:/peter/AB_data_v2017/data/reporting/nn-plant-sector-effects.csv")


load("e:/peter/AB_data_v2017/data/reporting/Summary of VPlant abundance by sector.RData")
load("e:/peter/AB_data_v2016/out/kgrid/veg-hf_1kmgrid_fix-fire.Rdata")
tv0 <- read.csv("~/repos/abmianalytics/lookup/lookup-veg-hf-age.csv")
tv0$Sector2 <- factor(ifelse(is.na(tv0$Sector), "NATIVE", as.character(tv0$Sector)),
    c("NATIVE", "Agriculture", "Energy", "Forestry", "Misc", "RuralUrban", "Transportation"))
VHF <- dd1km_pred[[1]]
tv0 <- tv0[colnames(VHF),]
compare_sets(colnames(VHF), rownames(tv0))
CS <- colSums(groupSums(VHF/10^6, 2, tv0$Sector2))
CS <- CS / sum(CS)

NN <- VP_SectorAbundance.Curr / rowSums(VP_SectorAbundance.Curr)
DD <- t(t(NN) / CS)

SE2 <- 100 * DD[,colnames(DD) != "Native"] / DD[,"Native"]
SE2 <- SE2[rownames(SE),]

op <- par(mfrow=c(2,3))
for (i in 2:6) {
plot(SE[Z$NN,i], SE2[Z$NN,i], xlab="Data based", ylab="Prediction based", 
     ylim=c(0, 4000), xlim=c(0, 500), main=colnames(SE)[i])
abline(0,1,col="grey")
abline(h=100,v=100,col="grey", lty=2)
}
par(op)

op <- par(mfrow=c(1,2))
boxplot(SE[Z$NN,], ylim=c(0,2000))
abline(h=100)
boxplot(SE2[Z$NN,], ylim=c(0,10000))
abline(h=100)
par(op)

```

